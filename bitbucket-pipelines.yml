# This is a sample build configuration for Python.
# Check our guides at https://confluence.atlassian.com/x/x4UWN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: atlassian/default-image:2

pipelines:
  default:
    - step:
        script:
          # install deps
          - apt-get update 
          - apt-get install apt-transport-https
          - dpkg --add-architecture i386
          - wget https://dl.winehq.org/wine-builds/Release.key
          - apt-key add Release.key
          - apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/
          - apt-get update 
          - apt-get install -y --allow-unauthenticated winehq-stable
          - apt-get install -y ninja-build mingw-w64 git python3-pip
          - pip3 install meson
          # prepare cpython code
          - git clone https://github.com/python/cpython.git cpython
          # native build
          - meson -Dsource=cpython builddir
          - ninja -C builddir
          # mingw build
          - meson -Dsource=cpython --cross-file cross-files/i686-w64-mingw32.txt builddir-i686-w64-mingw32
          - ninja -C builddir-i686-w64-mingw32
